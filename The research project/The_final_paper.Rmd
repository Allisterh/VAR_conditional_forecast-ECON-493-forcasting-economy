---
output:
  pdf_document: default
  html_document: default
  latex_engine: xelatex
fontsize: 12pt
mainfont: Times New Roman
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(ggplot2)
library(fpp2)
library(glmnet)
library(tidyr)
library(lmtest)
library(boot)
library(forecast)
library(readr)
library(ggfortify)
library(tseries)
library(urca)
library(readxl)
library(lubridate)
library(cansim)
library(OECD)
library(WDI)
library(fredr)
library(tsbox)
library(RColorBrewer)
library(wesanderson)
library(writexl)
library(gridExtra)
library(vars)
```

The data set used this paper are published by the whatever it is


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
#1.import the data
Can_housing_sell_data.raw <- read_excel("/Users/tie/Documents/GitHub/ECON-493-forcasting-economy/The research project/News_release_chart_data_mar_2023.xlsx", sheet = "Chart A", col_types = c("date",  "numeric", "numeric", "skip", "skip"))

#transfer data to ts form
Can_month_housing_sell.ts <- ts(Can_housing_sell_data.raw$Canada, start = c(2007, 1), end = c(2023, 2), frequency = 12)
```


The data is relative to the canadian housing reslate data from 2007 to 2023, by using this data, we could futhury sytudent waht is going on Canadian housing makret.

This paper is fousing on study how canadian housing market will respond to thepolicy rate change if Bank of Canadian remine the policy rate high as 4.5%. 

Author using the housing reslce data m and ther avalidalt macro data to consturion one ARIMA model and VAR model to conditional forecast if canaidna hosuing go over 45. 




```{r}

autoplot(Can_month_housing_sell.ts)
```
As shown in this graph, we can easily identify the trend of housing with the business cycle. The first drop can be explained as the dramatic impact of the 2008 financial crisis on the housing market. Another significant jump occurred around the beginning of 2020, when the first COVID-19 case was discovered in Canada, and COVID-19 became a global pandemic. Furthermore, as COVID-19 cases increased, the Canadian federal and provincial governments implemented COVID-19 restrictions to curb the spread, and the Bank of Canada lowered its policy rate to support the Canadian economy. As a result, there was a significant spike in housing sales. However, once the COVID-19 situation began to improve, and the war in Korea pushed up global energy prices, inflation in Canada reached an 8% 40-year high, resulting in a rising policy rate. As a result, the housing market began to cool down, and housing sales started to decline. 

Part One: Constructing the ARIMA Model

To better analyze the data, the author constructed four ARIMA models using different time periods. The first model used the entire data set from 2007 to 2023, while the second focused on the period from 2016 to 2023, during the COVID-19 pandemic. The third model covered the period from 2009 July, when the 2008 recession ended, to 2023, and the fourth model covered the period from 2007 to 2019 January, with the aim of avoiding the impact of COVID-19.

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
#data
#The entire data 
Can_month_housing_sell.ts <- ts(Can_housing_sell_data.raw$Canada, start = c(2007, 1), end = c(2023, 2), frequency = 12)

#The data set without 2008
after_2008_forecasting_data <- window(Can_month_housing_sell.ts, start= c(2009,7), end= c(2023,2))

#the Data from 2016 to 2023
The_before_during_after_Covid_model.data<-window(Can_month_housing_sell.ts, start= c(2016,1), end= c(2023,2))

#The data from 2007 to 2019 (the entire data without Covid shock)
Can_month_housing_sell_without_covid_shock.ts <- ts(Can_housing_sell_data.raw$Canada, start = c(2007, 1), end = c(2019, 1), frequency = 12)

#The data from 2008 to 2019 (After recession without covid shock)
after_2008_forecasting_without_covid_shock_data <- window(Can_month_housing_sell.ts, start= c(2009,7), end= c(2019, 1))

from_2007_to_2017 <- window(Can_month_housing_sell.ts, start= c(2007,1), end= c(2017, 1))
  

#construed model
all_data_model_1 <- auto.arima(Can_month_housing_sell.ts, 
                               approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                               num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                               start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                               max.d = 5, max.p = 5, max.q = 5)

all_data_model_2 <- auto.arima(Can_month_housing_sell.ts)

after_2008_forecasting_model_1 <- auto.arima(after_2008_forecasting_data, 
                                             approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                                             num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                                             start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                                             max.d = 5, max.p = 5, max.q = 5)

after_2008_forecasting_model_2 <- auto.arima(after_2008_forecasting_data)

The_before_during_after_Covid_model_1 <- auto.arima(The_before_during_after_Covid_model.data, d = 1,
                                                    approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                                                    num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                                                    start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                                                    max.d = 5, max.p = 5, max.q = 5)

The_before_during_after_Covid_model_2 <- auto.arima(The_before_during_after_Covid_model.data, d=1)

entil_data_without_covid_shock_1<- auto.arima(Can_month_housing_sell_without_covid_shock.ts, 
                                              approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                                              num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                                              start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                                              max.d = 5, max.p = 5, max.q = 5)

test_model_one_after_2008_forecasting_without_covid_shock_1 <- auto.arima(after_2008_forecasting_without_covid_shock_data,
                                                                          approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                                                                          num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                                                                          start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                                                                          max.d = 5, max.p = 5, max.q = 5)

entil_data_without_covid_shock_2 <- auto.arima(Can_month_housing_sell_without_covid_shock.ts)

test_model_one_after_2008_forecasting_without_covid_shock_2 <- auto.arima(after_2008_forecasting_without_covid_shock_data)

from_2007_to_2017_1 <- auto.arima(from_2007_to_2017,
                                  approximation = FALSE, parallel = TRUE, stepwise = FALSE,
                                  num.cores = 10, start.p = 0, start.q = 0, start.P = 0, 
                                  start.Q = 0, max.Q = 5, max.P = 5, max.D = 5,
                                  max.d = 5, max.p = 5, max.q = 5)

from_2007_to_2017_2 <- auto.arima(from_2007_to_2017)


####################
# Create a data frame with the names and ARIMA models
models_table <- data.frame(
  ARIMA = c(as.character(all_data_model_1), as.character(all_data_model_2), as.character(after_2008_forecasting_model_1), as.character(after_2008_forecasting_model_2),
            as.character(The_before_during_after_Covid_model_1), as.character(The_before_during_after_Covid_model_2), as.character(test_model_one_after_2008_forecasting_without_covid_shock_1),
            as.character(test_model_one_after_2008_forecasting_without_covid_shock_2), as.character(entil_data_without_covid_shock_1), as.character(entil_data_without_covid_shock_2),
            as.character(from_2007_to_2017_1), as.character(from_2007_to_2017_2))
)

# Print the table
print(models_table)
```


After doing het different airma function 12 times, we got 12 different arime function while most of them are repace with self. 

```{R echo=FALSE, message=FALSE, warning=FALSE}
model_table_2 <- data.frame(
  Model = c("ARIMA(2,1,0)", "ARIMA(0,1,1)", "ARIMA(2,1,2)(0,0,1)[12]", "ARIMA(0,1,0)")
)

print(model_table_2)

```


next,we will going to evaluate the different model to find out witch one is the best.
first, let compare their AIC and BIC

By fit the all different ARIMA cobmine into the data that without covid-19 impact to see which mode is working better on fit the model wihtout covid 19

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#fit the model into the entire data.
Can_month_housing_sell_without_Covid.ts <- ts(Can_housing_sell_data.raw$Canada, start = c(2007, 1), end = c(2019, 1), frequency = 12)

# Fit the ARIMA(2,1,0) model
model1_Without_Covid<- Arima(Can_month_housing_sell_without_Covid.ts, order=c(2,1,0))

# Fit the ARIMA(0,1,1) model
model2_Without_Covid<- Arima(Can_month_housing_sell_without_Covid.ts, order=c(0,1,1))

# Fit the ARIMA(2,1,2)(0,0,1)[12] model with zero mean
model3_Without_Covid <- Arima(Can_month_housing_sell_without_Covid.ts, order=c(2,1,2), seasonal=list(order=c(0,0,1), period=12))

# Fit the ARIMA(0,1,0) model
model4_Without_Covid <- Arima(Can_month_housing_sell_without_Covid.ts, order=c(0,1,1))



#4.3 AIC and BIC for data without covid.
AIC_and_BIC_Matrix_for_without_covid<- matrix (ncol = 2, nrow = 4)
colnames(AIC_and_BIC_Matrix_for_without_covid) <-c("AIC","BIC")
rownames(AIC_and_BIC_Matrix_for_without_covid) <-c("ARIMA(2,1,0)", "ARIMA(0,1,1)", "ARIMA(2,1,2)(0,0,1)[12]", "ARIMA(0,1,0)")
AIC_and_BIC_Matrix_for_without_covid[1,1] <- AIC(model1_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[2,1] <- AIC(model2_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[3,1] <- AIC(model3_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[4,1] <- AIC(model4_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[1,2] <- BIC(model1_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[2,2] <- BIC(model2_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[3,2] <- BIC(model3_Without_Covid)
AIC_and_BIC_Matrix_for_without_covid[4,2] <- BIC(model4_Without_Covid)
print(AIC_and_BIC_Matrix_for_without_covid)

```
As the output show, the ARIMA(2,1,2)(0,0,1)[12], it may relace to this combination is generate base on the data from 2007 to 2019, which are not suprised at all.


compare the AIC and BIC model base on the data that including the covid influence.
```{r echo=FALSE}
#fit the model into the entire data.
Can_month_housing_sell.ts <- ts(Can_housing_sell_data.raw$Canada, start = c(2007, 1), end = c(2023, 2), frequency = 12)

# Fit the ARIMA(2,1,0) model
model1<- Arima(Can_month_housing_sell.ts, order=c(2,1,0))

# Fit the ARIMA(0,1,1) model
model2<- Arima(Can_month_housing_sell.ts, order=c(0,1,1))

# Fit the ARIMA(2,1,2)(0,0,1)[12] model with zero mean
model3 <- Arima(Can_month_housing_sell.ts , order=c(2,1,2), seasonal=list(order=c(0,0,1), period=12))

# Fit the ARIMA(0,1,0) model
model4<- Arima(Can_month_housing_sell.ts , order=c(0,1,1))

#AIC and BIC for the entire data
AIC_and_BIC_Matrix <- matrix (ncol = 2, nrow = 4)
colnames(AIC_and_BIC_Matrix) <-c("AIC","BIC")
rownames(AIC_and_BIC_Matrix) <-c("ARIMA(2,1,0)", "ARIMA(0,1,1)", "ARIMA(2,1,2)(0,0,1)[12]", "ARIMA(0,1,0)")
AIC_and_BIC_Matrix[1,1] <- AIC(model1)
AIC_and_BIC_Matrix[2,1] <- AIC(model2)
AIC_and_BIC_Matrix[3,1] <- AIC(model3)
AIC_and_BIC_Matrix[4,1] <- AIC(model4)
AIC_and_BIC_Matrix[1,2] <- BIC(model1)
AIC_and_BIC_Matrix[2,2] <- BIC(model2)
AIC_and_BIC_Matrix[3,2] <- BIC(model3)
AIC_and_BIC_Matrix[4,2] <- BIC(model4)
print(AIC_and_BIC_Matrix)
```
Unsprised, the ARIMA(2,1,0) is best accrding to it AIC value, due to its fit by from the entire data set. 


Futher, let's do the cross validation of four model on the data that inculding the covid and without the cov

the cross valdation

Furthermore, let's perform cross-validation on four models using data that includes and excludes the COVID period. The cross-validation process involves training the models using data up to 2016 and testing them using data from 2016 to 2019. Assuming that the relationship between housing sales and other macroeconomic factors remains the same in the post-COVID period, we can focus on the market's behavior during normal times and ignore the impact of COVID. Therefore, this cross-validation test starts with the training set from 2007 to 2015 and uses the dataset from 2016 to 2018 for testing to evaluate the model's goodness.


```{r echo=FALSE, paged.print=FALSE}

n.end <- 2015
n_test <- 12 * (2019- 2016) #the times we need go
n_models <- 4  

#set the martix pred
pred <- matrix(rep(NA, n_test * (n_models + 1)), nrow=n_test, ncol=(n_models + 1)) 

# the for loop
for (i in 1: n_test ) {
  tmp0 <- 2007 #the training start at 2007 
  tmp1 <- n.end + (i - 2) * (1/12) #the end of training windows 
  tmp <- window(Can_month_housing_sell.ts, start=tmp0, end=tmp1) 
  #the training data set from 2007 to the date to its end
  #2007 to 2016 + (observation windos)

  
#The acutally value
  pred[i, 1] <- window(Can_month_housing_sell.ts, start=tmp1 + (1/12), end=tmp1 + (1/12))
  
#moding time!
  model1 <- Arima(tmp, order=c(2,1,0))
  model2 <- Arima(tmp, order=c(0,1,1))
  model3 <- Arima(tmp, order=c(2,1,2), seasonal=list(order=c(0,0,1), period=12))
  model4 <- Arima(tmp, order=c(0,1,0))
  
#one step
  pred[i, 2] <- forecast(model1, h=1)$mean
  pred[i, 3] <- forecast(model2, h=1)$mean
  pred[i, 4] <- forecast(model3, h=1)$mean
  pred[i, 5] <- forecast(model4, h=1)$mean
}

#calculate the error

error <- (pred[, -1] - pred[, 1])
mse <- colMeans(error)
rmse <- sqrt(colMeans(error^2))
mae <- colMeans(abs(error))
mpe <- colMeans((error/ pred[, 1]) * 100)
mape <- colMeans(abs((error/ pred[, 1]) * 100))

#The outcome
The_evil_df <- data.frame(
  Model = c("ARIMA(2,1,0)", "ARIMA(0,1,1)", "ARIMA(2,1,2)(0,0,1)[12]",  "ARIMA(0,1,0)"),
  ME = mse,
  RMSE = rmse,
  MAE = mae,
  MPE = mpe,
  MAPE = mape
)

print(The_evil_df)


```

Based on the provided error metrics, the best model appears to be ARIMA(0,1,1) as it has the lowest MAE (1977.793) and the second-lowest MAPE (5.568452). Lower error metrics indicate better model performance.
however, ARIMA(2,1,0) has the lowest AIC in both with or without covid influence.it suggests that this model might be the best balance between model complexity and goodness of fit.Given this new information, The ARIMA(2,1,0 to consider the ARIMA(2,1,0) model as the best 





